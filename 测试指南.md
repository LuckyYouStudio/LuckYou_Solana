# Solana项目测试完整指南

## 一、环境安装

### 1. 安装Rust
```bash
# Windows用户
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 验证安装
rustc --version
cargo --version
```

### 2. 安装Solana CLI
```bash
# Windows用户下载安装包
curl -L https://github.com/anza-xyz/agave/releases/latest/download/solana-install-init-x86_64-pc-windows-msvc.exe -o solana-install.exe
./solana-install.exe stable

# Linux/Mac用户
sh -c "$(curl -sSfL https://release.solana.com/stable/install)"

# 验证安装
solana --version
```

### 3. 安装Anchor
```bash
# 使用cargo安装
cargo install --git https://github.com/coral-xyz/anchor anchor-cli --locked

# 或使用npm（可能不支持所有平台）
npm install -g @coral-xyz/anchor-cli

# 验证安装
anchor --version
```

### 4. 安装Node依赖
```bash
# 在项目目录下
npm install
```

## 二、配置Solana

### 1. 配置网络
```bash
# 设置为本地网络（用于测试）
solana config set --url localhost

# 或设置为开发网
solana config set --url devnet

# 查看当前配置
solana config get
```

### 2. 创建钱包
```bash
# 生成新的密钥对
solana-keygen new

# 查看钱包地址
solana address

# 查看余额
solana balance
```

### 3. 获取测试代币
```bash
# 在devnet上获取测试SOL
solana airdrop 2

# 在本地网络需要先启动验证器
solana-test-validator
```

## 三、运行测试

### 方法1：使用Anchor测试（推荐）

```bash
# 启动本地验证器并运行测试
anchor test

# 仅构建程序
anchor build

# 部署到本地网络
anchor deploy

# 运行特定测试文件
anchor test --skip-build --skip-deploy
```

### 方法2：分步测试

```bash
# 1. 启动本地Solana节点
solana-test-validator

# 2. 在新终端构建程序
anchor build

# 3. 部署程序
anchor deploy

# 4. 运行测试
npm test
```

### 方法3：使用Cargo测试Rust代码

```bash
# 测试Rust程序逻辑
cargo test

# 使用BPF目标构建
cargo build-bpf
```

## 四、测试脚本说明

### 测试文件位置
```
tests/
└── luck_snake.ts  # 主测试文件
```

### 测试内容
1. **初始化测试** - 设置程序管理员和财库
2. **生成数字测试** - 用户付费生成随机数
3. **唯一性测试** - 验证数字不重复
4. **提取资金测试** - 管理员提取功能
5. **权限测试** - 验证权限控制

## 五、常见问题解决

### 1. "anchor: command not found"
```bash
# 添加到PATH
export PATH="$HOME/.cargo/bin:$PATH"

# Windows用户
set PATH=%USERPROFILE%\.cargo\bin;%PATH%
```

### 2. "insufficient funds"错误
```bash
# 获取更多测试代币
solana airdrop 5
```

### 3. 连接错误
```bash
# 确保本地验证器运行中
solana-test-validator

# 检查RPC连接
solana cluster-version
```

### 4. 构建错误
```bash
# 清理并重新构建
anchor clean
anchor build
```

## 六、测试命令速查

```bash
# 完整测试流程
anchor test

# 仅运行JavaScript测试
npm test

# 查看程序日志
solana logs

# 查看账户信息
solana account <ADDRESS>

# 查看程序信息
solana program show <PROGRAM_ID>
```

## 七、测试最佳实践

1. **隔离测试环境**
   - 每个测试使用新的账户
   - 避免测试间相互影响

2. **完整的测试覆盖**
   - 正常流程测试
   - 异常情况测试
   - 边界条件测试

3. **日志和调试**
   ```rust
   // 在Rust代码中添加日志
   msg!("Debug info: {}", value);
   ```

4. **使用断言验证**
   ```typescript
   // 在测试中验证结果
   expect(result).to.equal(expected);
   ```

## 八、快速开始脚本

创建 `test.sh` (Linux/Mac) 或 `test.bat` (Windows)：

### Linux/Mac版本 (test.sh)
```bash
#!/bin/bash
echo "Starting Solana test validator..."
solana-test-validator &
VALIDATOR_PID=$!

sleep 5

echo "Running Anchor tests..."
anchor test --skip-local-validator

kill $VALIDATOR_PID
echo "Tests completed!"
```

### Windows版本 (test.bat)
```batch
@echo off
echo Starting Solana test validator...
start /B solana-test-validator

timeout /t 5

echo Running Anchor tests...
anchor test --skip-local-validator

echo Tests completed!
taskkill /F /IM solana-test-validator.exe
```

## 九、调试技巧

### 1. 查看交易详情
```bash
# 获取交易签名后
solana confirm -v <TRANSACTION_SIGNATURE>
```

### 2. 监控程序日志
```bash
# 实时查看程序输出
solana logs | grep "Program H3nY6p"
```

### 3. 使用Anchor的IDL
```bash
# 查看程序接口
anchor idl fetch <PROGRAM_ID>
```

## 十、部署到主网

```bash
# 1. 切换到主网
solana config set --url mainnet-beta

# 2. 确保有足够的SOL
solana balance

# 3. 部署程序
anchor deploy --provider.cluster mainnet

# 4. 验证部署
solana program show <PROGRAM_ID>
```

---

💡 **提示**：建议先在本地和devnet充分测试后再部署到主网！